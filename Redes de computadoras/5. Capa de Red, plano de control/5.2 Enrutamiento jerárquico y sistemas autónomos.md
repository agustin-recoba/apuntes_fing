**Sistemas aut√≥nomos (AS)**, formados por un grupo de routers que normalmente se encuentran bajo el mismo control administrativo. Los routers de un mismo AS ejecutan todos ellos el mismo algoritmo de enrutamiento.

**Protocolo de enrutamiento interno del sistema aut√≥nomo:** el algoritmo de enrutamiento que se ejecuta en el sistema. 

**Routers gateways:** routers de un sistema aut√≥nomo que tendr√°n la tarea adicional de ser responsables del reenvio de paquetes a los destinos externos al AS.

Un protocolo de enrutamiento interno cumple la tarea de obtener informaci√≥n de alcanzabilidad de los AS vecinos y propagar dicha informaci√≥n de alcanzabilidad a todos los routers internos del AS.
Cuando un sistema aut√≥nomo obtiene informaci√≥n acerca de un destino de un AS vecino, puede anunciar esta informaci√≥n de enrutamiento a algunos de sus otros sistemas aut√≥nomos vecinos.

![[Pasted image 20221118105810.png|400]]

```ad-example
title: M√©todo de la patata caliente
Un m√©todo, que es el que se suele utilizar en la pr√°ctica, consistir√≠a en utilizar el enrutamiento de la **patata caliente**. Con este tipo de enrutamiento, el sistema aut√≥nomo suelta el paquete tan r√°pido como sea posible (de la forma m√°s barata posible). 

Para hacer esto, el router env√≠a el paquete al router de pasarela que tiene el coste m√°s peque√±o de entre todos los routers de pasarela que cuentan con una ruta hasta ese destino.
```

```ad-example
title: Definiendo una entrada en la tabla de forwarding de un router
collapse: open
Supongamos que AS1 aprende por medio de un protocolo inter-AS que la subred ùëã es alcanzable a trav√©s de AS3, por el Gateway 1c, pero no v√≠a AS2; luego el protocolo inter-AS propaga esa informaci√≥n a todos los routers internos. Luego el router 1d determina por el algoritmo de ruteo intra-AS que la interfaz ùêº est√° en el camino de costo m√≠nimo, por lo que agrega a la tabla de forwarding la entrada (ùëã,ùêº).

</br>

![[Pasted image 20221118110145.png|500]]

</br>

Ahora suponemos que AS1 aprende por el protocolo inter-AS que la subred ùëã es alcanzable tanto por AS3 como por AS2, entonces, para configurar la tabla de forwarding, el router 1d debe determinar por qu√© Gateway redirigir los paquetes para el destino ùëã, lo cual es un trabajo para el protocolo de ruteo inter-AS.

</br>

![[Pasted image 20221118110225.png|500]]
```

# Enrutamiento en Internet

## INTRA-AS ROUTING (IGP)
El protocolo Intra-AS es utilizado para determinar c√≥mo es ejecutado el ruteo dentro del sistema aut√≥nomo. Son conocidos tambi√©n son conocidos como **Interior Gateway Protocols (IGP)**.

Los m√°s utilizados son:
- **RIP**: Routing Information Protocol
- **OSPF**: Open Shortest Path First
- **IGRP**: Interior Gateway Routing Protocol

Los protocolos de enrutamiento internos de los AS se conocen tambi√©n como **protocolos de pasarela interior.**

### Routing Information Protocol (RIP)
RIP es un protocolo de **vector de distancias** que opera de una forma muy parecida al protocolo DV "ideal". Utiliza como m√©trica de coste el recuento de saltos; es decir, cada enlace tiene un coste de 1. Fue dise√±ado para **redes peque√±as o medianas** y por esto establece que un camino dentro de la red tiene un m√°ximo de 15 hops. De esta manera utiliza **16 como infinito**.

El vector de distancias para cualquier router es la estimaci√≥n actual de la ruta m√°s corta desde dicho router a las subredes del AS. En RIP, las actualizaciones de enrutamientos son intercambiadas entre los vecinos cada 30 segundos mediante un **mensaje de respuesta RIP.**

El mensaje de respuesta enviado por un router o un host contiene una lista de hasta 25 subredes de destino pertenecientes al sistema aut√≥nomo, as√≠ como la distancia desde el emisor a cada una de esas subredes. Los mensajes de respuesta se conocen como **anuncios RIP**.

Cada router mantiene una tabla RIP conocida como tabla de enrutamiento, esta tabla incluye tanto el vector de distancia del router como la tabla de reenv√≠o del mismo.
Si un router no tienen noticias de su vecino al menos una vez cada 180 segundos, considera que ese vecino ya no es alcanzable; es decir, o bien ese vecino ha muerto o el enlace que le conectaba con el ha fallado. Si esto ocurre, RIP modifica su tabla de enrutamiento local, y luego propagara esta informaci√≥n enviando anuncios a sus routers vecinos. Los fallos de enlace se propagan r√°pidamente a la red completa, utilizando **reversa envenenada** para evitar ping-pong loops, con la distancia infinita igual a 16hops.

Un router tambi√©n puede solicitar informaci√≥n de otros mediante un mensaje de solicitud RIP, acerca del coste a un destino dado. Esto se realiza mediante mensajes UDP en el puerto 520.

### OPEN SHORTEST PATH FIRST (OSPF)

Protocolo de **estado de enlaces** que utiliza la t√©cnica de inundaci√≥n de informaci√≥n de estados de los enlaces y el algoritmo de **c√°lculo de ruta de coste m√≠nimo de Dijkstra.**

OSPF es un protocolo de enrutamiento **intradominio**, que permite el enrutamiento jer√°rquico, y lo hace **dividiendo un AS en zonas**.

Con OSPF, un router construye un mapa topol√≥gico completo del sistema aut√≥nomo entero, es decir un grafo. A continuaci√≥n, el router ejecuta localmente el algoritmo de la ruta m√°s corta de Dijkstra para determinar un √°rbol de rutas m√°s cortas a todas las subredes, con √©l mismo como nodo ra√≠z. 

El administrador de la red configura los costes de los enlaces individuales, adem√°s puede decidir hacer igual a 1 el coste de todos los enlaces, proporcionando un enrutamiento de n√∫mero m√≠nimo de saltos, o puede definir los pesos de los enlaces para que sea inversamente proporcionales a la capacidad de los mismos, con el fin de disuadir el tr√°fico a utilizar los enlaces con peque√±o ancho de banda. 
OSPF no establece una pol√≠tica para definir el pesos de los enlaces, sino que proporciona mecanismos para determinar el enrutamiento de coste m√≠nimo para el conjunto dado de pesos de los enlaces.

Con OSPF, un router difunde la informaci√≥n de enrutamiento a todos los dem√°s routers del sistema aut√≥nomo, no solo a sus routers vecinos. Esta informaci√≥n se difunde cuando se ha producido un cambio en el estado de un enlace, tambi√©n difunde esta informaci√≥n en menos de 30 minutos, incluso aunque no haya cambiado el estado.
Lo anuncios OSPF est√°n contenidos en **OSPF messages** que son transportados **directamente por IP**, siendo el n√∫mero de protocolo de la capa superior para OSPF igual a 89 (header tipo de IP). As√≠, el protocolo tiene que implementar por s√≠ mismo funcionalidades tales como la transferencia fiable de mensajes y la de env√≠o de mensajes de difusi√≥n acerca del estados de los enlaces. 

OSPF comprueba que los enlaces est√°n operativos mediante que el mensaje HELLO que se env√≠a a un vecino conectado, y permite al router OSPF obtener de un vecino la base de datos de estado de los enlaces de toda la red.

Algunas de las funcionalidades avanzadas incluidas en OSPF son las siguientes:
  - Seguridad: 
	Los intercambios entre routers OSPF pueden ser autentificados.
    Con esto solo pueden participar en el protocolo OSPF los routers de confianza del sistema aut√≥nomo. Por defecto, los paquetes OSPF entre routers no son identificados y podr√≠an ser alterados. Pueden configurarse dos tipos de autenticaci√≥n: simple y MD5.
  - Varias rutas de igual coste:
	Cuando varias rutas de un destino tienen el mismo coste, OSPF permite utilizar varias rutas.
  - Soporte integrado para enrutamiento de unidifusi√≥n y por multidifusi√≥n: 
	OSP multidifusi√≥n a√±ade extensiones simples a OSPF para proporcionar enrutamiento por multidifusi√≥n.
- Soporte para a√±adir una jerarqu√≠a dentro de un mismo dominio de enrutamiento.

#### OSPF jer√°rquico
Se tienen dos niveles de jerarqu√≠a, **√°rea local** y **backbone**. Los advertisements de link-state solo ocurren en √°rea local. Cada nodo tiene una topolog√≠a detallada de √°reas, solo sabe direcciones a redes en otras √°reas.

![[Pasted image 20221118112110.png|500]]

Varios elementos: 
- Area border routers: resume las distancias a redes en su propia √°rea y avisa a otros Area border routers.
- Backbone routers: corren el ruteo OSPF limitado al backbone.
- Boundary routers: conectan con otros AS.


## Enrutamiento entre sistemas aut√≥nomos: BGP

BGP es un protocolo de enrutamientos entre sistemas aut√≥nomos que proporciona a cada sistema aut√≥nomo mecanismos para:
- Obtener informaci√≥n acerca de la alcanzabilidad de las subredes de los sistemas aut√≥nomos vecinos.
- Propagar la informaci√≥n de alcanzabilidada a todos los routers internos del sistema aut√≥nomo.
- Determinar buenas rutas de subredes, bas√°ndose en la informaci√≥n de alcanzabilidad y en la pol√≠tica del sistema aut√≥nomo.
Lo m√°s importante es que BGP permite a cada subred anunciar su existencia al resto de Internet.

En BGP, los pares de routers intercambian la informaci√≥n de ruteo mediante conexiones TCP semipermanentes en el puerto 179. En general, existe una conexi√≥n BGP-TCP por cada enlace que conecta directamente dos routers en dos AS distintos. Adem√°s, hay tambi√©n una conexi√≥n TCP semipermanente entre los routers dentro del AS.

Para cada conexi√≥n TCP, los dos routers situados en los extremos de la conexi√≥n se denominan **pares BGP** y la conexi√≥n TCP junto con todos los mensajes BGP enviados a trav√©s de la conexi√≥n se denomina **sesi√≥n BGP.** Adem√°s, una sesi√≥n BGP que abarca dos sistemas aut√≥nomos se conoce como **sesi√≥n externa BGP** (eBGP) y una sesi√≥n BGP entre routers de un mismo sistema aut√≥nomo se conoce como **sesi√≥n interna BGP** (iBGP).

BGP permite que cada sistema aut√≥nomo aprenda qu√© destinos son alcanzables a trav√©s de sus sistemas aut√≥nomos vecinos. En BGP, los destinos no son hosts sino prefijos CIDR, representando cada prefijo una subred o una colecci√≥n de subredes.

### Atributos de ruta y rutas BGP
En BGP, un sistema aut√≥nomo se identifica mediante su n√∫mero de sistema aut√≥nomo (**ASN, Autonomous System Number**) globalmente √∫nico.

Atributos BGP:
- **AS-PATH**: contiene los sistemas aut√≥nomos a trav√©s de los que ha pasado el anuncio del prefijo. Cuando se ha pasado un prefijo dentro de un sistema aut√≥nomo, el sistema a√±ade su ASN al atributo AS-PATH. Los routers utilizan este atributo para impedir los bucles de anuncios.
- El siguiente salto (**NEXT HOP**) es la interfaz del router que inicia la secuencia de sistemas aut√≥nomos (osea la AS-PATH).

Adem√°s, BGP incluye atributos que permiten a los routers asignar m√©tricas de preferencia en las rutas, y un atributo que indica como el prefijo fue insertado en BGP en el AS de origen. 
Cuando un **Gateway router** recibe un aviso de ruta, utiliza su **import policy** para decidir si aceptarla o rechazarla, por ejemplo, sabiendo que nunca se debe hacer el ruteo por el ASxyz.

### Selecci√≥n de la ruta BGP

Un router puede aprender acerca de m√°s de una ruta a cualquier prefijo, en cuyo caso tendr√° que seleccionar una de las posibles rutas. Las entradas para este proceso de selecci√≥n de ruta es el conjunto de todas las rutas que han sido aprendidas y aceptadas por el router. 

Si existen dos rutas con el mismo prefijo, entonces BGP invoca secuencialmente las siguientes reglas de eliminaci√≥n hasta quedarse con una ruta:
1. Valor del atributo de preferencia local, que puede ser definido por el router, o aprendido desde otro router en el mismo AS. Esta pol√≠tica de decisi√≥n es llevada a cabo por el administrador de red del AS.
2. AS-PATH m√°s corto
3. El router NEXT-HOP m√°s cercano, utilizando el ruteo de la papa caliente.
4. Si todav√≠a quedan rutas, entonces se aplican criterios adicionales.

Es importante observar que **no se puede afirmar que la decisi√≥n garantiza un camino m√°s corto en cantidad de hops de routers**, porque se desconoce la informaci√≥n interna de cada AS. Un camino con AS-PATH m√°s corto puede incluir ASs con muchos ‚Äúhops‚Äù de routers internos, y puede ser m√°s largo en t√©rmino de routers que otro camino con AS-PATH m√°s largo.

### Mensajes BGP

Los mensajes BGP se intercambian usando TCP.
- **OPEN**: abre conexi√≥n TCP con ‚Äúpeer‚Äù y autentica al que env√≠a.
- **UPDATE**: publica nuevos caminos (o da de baja otros).
- **KEEPALIVE**: mantiene la conexi√≥n viva en ausencia de UPDATES; se usa tambi√©n como ACK del OPEN.
- **NOTIFICATION**: reporta errores en mensaje previo; tambi√©n se usa para cerrar la conexi√≥n.

### Pol√≠tica de ruteo en BGP:

![[Pasted image 20221118115118.png]]

- A, B, C son proveedores de red. 
- X, W, Y son clientes de los proveedores.
- X es dual-homed, ya que est√° asociado a dos redes. Por lo que X no quiere ‚Äúrutear‚Äù desde B por X a C, de esta forma, X no avisara a B una ruta a C.
- A avisa un camino AW a B.
- B avisa un camino BAW a X.
- As√≠, surge la consulta de si B debe avisar del camino BAW a C:
	- No, ya que B no obtiene ‚Äúingresos‚Äù por hacer el ruteo CBAW ya que ni W ni C son clientes de B.
	- B quiere forzar a C a rutear por w a trav√©s de A. 
	- B quiere rutear solamente desde/hacia sus clientes.

## ¬øPor qu√© diferentes ruteos Intra-AS e Inter-AS? 

### Pol√≠ticas:
- Inter-AS: el administrador quiere el control sobre como su tr√°fico es ruteado, es decir, quien rutea a trav√©s de su red.
- Intra-AS: un √∫nico administrador, por lo que no se necesitan pol√≠ticas de decisi√≥n.

### Escala:
- El ruteo jer√°rquico reduce el tama√±o de la tabla.

### Rendimiento:
- Intra-AS: puede enfocarse en el rendimiento.
- Inter-AS: las pol√≠ticas deben dominar por sobre el rendimiento.